<html>
    <body>
        <div id="app">
            <input type="text" v-model="name">
            {{name}}
        </div>
    </body>
    <script>
        var app=document.getElementById('app')
        var data={
            name:'aaa'
        }
        function observer(){
            this.dep=new Dep
            // Object.keys(data).forEach(function(key){
            //     var val=data[key]
            //     Object.defineProperty(data,key,{
            //         enumerable:true,
            //         configurable:false,
            //         get:function(){
            //             Dep.target&&dep.addSub(Dep.target)
            //             return val
            //         },
            //         set:function(newVal){
            //             val=newVal
            //             dep.notify()
            //         }
            //     })
            // })
        }
        observer.prototype={
            init:function(data){
                var me=this
                var _data=new Proxy(data,{
                    get:function(target, propKey,receiver){
                        console.log(receiver)
                        receiver.sub&&me.dep.addSub(receiver.sub)
                        return target[propKey]
                    },
                    set:function(target, propKey, value){
                        target[propKey]=value
                        me.dep.notify()
                    }
                })
                return _data
            }
        }
        function Dep(){
            this.subs=[]
        }
        Dep.prototype={
            addSub:function(sub){
                this.subs.push(sub)
            },
            notify:function(){
                this.subs.forEach(function(sub){
                    sub.update()
                })
            }
        }
        function Compile(el,vm){
            this.$vm=vm
            this.$el=el
            this.$fragment=this.initFragment()
            this.compileElement(this.$fragment)
            el.appendChild(this.$fragment)
        }
        Compile.prototype={
            initFragment:function(){
                var fragment=document.createDocumentFragment(),child
                while (child=this.$el.firstChild) {
                    fragment.appendChild(child)
                }
                return fragment
            },
            compileElement:function(el){
                var childNodes=el.childNodes, me=this;
                [].slice.call(childNodes).forEach(function(node){
                    var text=node.textContent
                    if(node.nodeType===1){ // 元素节点
                        [].slice.call(node.attributes).forEach(function(attr){
                            var reg=/v\-(.*)/
                            if(reg.test(attr.name)){
                                switch(RegExp.$1){
                                    case 'model':
                                        var exp=attr.nodeValue
                                        node.value=me.$vm[exp]
                                        node.addEventListener('input',function(e){
                                            me.$vm[exp]=e.target.value
                                        })
                                        new Watcher(me.$vm,exp,function(value){
                                            me.$vm[exp]=value
                                            node.value=value
                                        })
                                }
                            }
                        })
                    }else if(node.nodeType===3){
                        var reg=/\{\{(.*)\}\}/
                        if(reg.test(text)){
                            var exp=RegExp.$1
                            node.textContent=me.$vm[exp]
                            new Watcher(me.$vm,exp,function(value){
                                node.textContent=value
                            })
                        }
                    }
                    if(node.childNodes&&node.childNodes.length){
                        me.compileElement(node.childNodes)
                    }
                })
            }
        }
        function Watcher(vm,exp,cb){
            this.vm=vm
            this.exp=exp
            this.cb=cb
            this.value=this.get()
            this.sub=this
        }
        Watcher.prototype={
            update:function(){
                this.run()
            },
            run:function(){
                var value=this.get()
                var oldValue=this.value
                if(oldValue!==value){
                    this.value=value
                    this.cb.call(this.vm,value,oldValue)
                }
            },
            get:function(){
                var value=this.vm[this.exp]
                return value
            }
        }
        var options={
            el:app,
            data:data
        }
        function Vue(options){
            var me=this
            var ob=new observer
            this.$el=options.el
            this._data=ob.init(options.data)

            Object.keys(data).forEach(function(key){
                me.proxy(key)
            })
            this.$compile=new Compile(this.$el,this)
        }
        Vue.prototype={
            proxy:function(key){
                Object.defineProperty(this,key,{
                    enumerable:true,
                    configurable:false,
                    get:function(){
                        return this._data[key]
                    },
                    set:function(newValue){
                        this._data[key]=newValue
                    }
                })
            }
        }
        var instance=new Vue(options)

        // var instance=new Proxy(vue,{
        //     get:function(target, propKey){
        //         console.log(propKey)
        //         // if(propKey!=='_data'&&target._data.hasOwnProperty(propKey)){
        //         //     return target._data[propKey]
        //         // }
        //         return target[propKey]
        //     },
        //     set:function(target, propKey, value){
        //         if(propKey!=='_data'&&target._data.hasOwnProperty(propKey)){
        //             return target._data[propKey]=value
        //         }
        //         target[propKey]=value
        //     }
        // })
    </script>
</html>